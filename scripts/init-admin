#!/bin/bash
# init-admin - Initialize the admin orchestrator project
#
# Run this in /data/repos to create a general-purpose workspace
# for VM-wide tasks like cloning repos, system management, etc.
#
# Safe to run multiple times - only creates missing files.
#
# Usage: init-admin [--force]

set -e

ADMIN_DIR="/data/repos/admin"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

print_success() {
    echo -e "${GREEN}âœ“${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}!${NC} $1"
}

# Check we're in /data/repos or the admin dir itself, or allow override
if [ "$(pwd)" != "/data/repos" ] && [ "$(pwd)" != "$ADMIN_DIR" ] && [ "$1" != "--force" ]; then
    echo "Run this from /data/repos or use --force"
    echo "Usage: cd /data/repos && init-admin"
    exit 1
fi

# Create directory
if [ -d "$ADMIN_DIR" ]; then
    print_warning "admin directory already exists"
else
    mkdir -p "$ADMIN_DIR"
    print_success "Created $ADMIN_DIR"
fi

cd "$ADMIN_DIR"

# Initialize git repo
if [ -d ".git" ]; then
    print_warning "Git repo already initialized"
else
    git init -q
    print_success "Initialized git repo"
fi

# Create CLAUDE.md (only if missing)
if [ -f "CLAUDE.md" ]; then
    print_warning "CLAUDE.md already exists (skipping)"
else
    cat > CLAUDE.md << 'CLAUDE_EOF'
# Admin / Orchestrator Agent

General-purpose workspace for VM-wide tasks. This agent can manage repos, create other agents, and handle tasks that span multiple projects.

## Important: Read NOTES.md First

Before starting any task, read `NOTES.md` for:
- List of repos on this VM and their purposes
- Learnings and gotchas discovered over time
- Common tasks and how to do them

**Update NOTES.md** when you learn something new or complete a significant task.

## Capabilities

### Repo Management

```bash
# Clone a new repo
cd /data/repos && git clone git@github.com:org/repo.git

# Or via HTTPS (if gh auth is configured)
cd /data/repos && git clone https://github.com/org/repo.git
```

### Agent Management

```bash
cc-ls                                    # List running agents
cc-new <name> /data/repos/<project>      # Create new agent
cc-new <name> @<project>/<branch>        # Create agent with worktree
cc-stop <name>                           # Stop an agent
cc-attach <name>                         # Attach to agent (from SSH)
```

### Takopi Management

```bash
takopi-add-project <name>                # Add project to Takopi config
takopi-restart                           # Restart Takopi bot
```

### System Info

```bash
df -h /data                              # Check disk space
du -sh /data/repos/*                     # Repo sizes
cc-ls                                    # Running agents
tailscale status                         # Network status
```

## Project Locations

All repos live in `/data/repos/`:

```bash
ls -la /data/repos/
```

## Guidelines

- Clone repos into `/data/repos/<repo-name>`
- After cloning, run `takopi-add-project <name>` to enable Telegram access
- For project-specific work, suggest the user switch to that project's Telegram topic
- Don't modify files in other projects unless explicitly asked
- This workspace is for orchestration, not deep coding tasks
- **Always update NOTES.md** with new learnings

## Common Tasks

### Set up a new project

```bash
cd /data/repos
git clone git@github.com:org/new-repo.git
takopi-add-project new-repo
# Then in Telegram: create topic "new-repo" and run /ctx set new-repo
```

After setup, add the project to NOTES.md under "Repos on this VM".

### Check VM health

```bash
df -h /data                              # Disk space
free -h                                  # Memory
cc-ls                                    # Running agents
tail -20 /data/logs/healthcheck.log      # Health monitor
```

### Clean up disk space

```bash
pnpm store prune                         # Clean pnpm cache
rm -rf ~/.cache/ms-playwright            # Remove Playwright
npm cache clean --force                  # Clean npm cache
```
CLAUDE_EOF
    print_success "Created CLAUDE.md"
fi

# Create NOTES.md (only if missing)
if [ -f "NOTES.md" ]; then
    print_warning "NOTES.md already exists (skipping)"
else
    cat > NOTES.md << 'NOTES_EOF'
# Admin Notes

Cross-session memory for the orchestrator agent. Update this file when you learn something new.

## Repos on this VM

<!-- List repos with brief descriptions. Update when adding new repos. -->

| Repo | Description | Notes |
|------|-------------|-------|
| admin | This orchestrator workspace | General VM tasks |

## Learnings & Gotchas

<!-- Things discovered that should be remembered across sessions -->

- Takopi project names cannot start with underscore
- OPENAI_API_KEY required for voice transcription in Telegram
- pnpm store can grow to 5GB+, prune with `pnpm store prune`
- Default volume is 10GB, extend with `fly volumes extend`

## Common Workflows

<!-- Document repeated tasks for quick reference -->

### New Repo Setup
1. `cd /data/repos && git clone <url>`
2. `takopi-add-project <name>`
3. Create Telegram topic, run `/ctx set <name>`
4. Update this file's "Repos on this VM" table

### Disk Space Low
1. `df -h /data` to check usage
2. `du -sh /data/repos/*` for repo sizes
3. `pnpm store prune` to clean pnpm
4. `rm -rf ~/.cache/ms-playwright` if not needed

## Pending Tasks

<!-- Optional: track cross-session todos -->

- [ ] Example: Set up monitoring for X
NOTES_EOF
    print_success "Created NOTES.md"
fi

# Create .gitignore (only if missing)
if [ -f ".gitignore" ]; then
    print_warning ".gitignore already exists (skipping)"
else
    cat > .gitignore << 'GITIGNORE_EOF'
# Local files
*.log
*.tmp
.DS_Store

# Secrets
.env
*.key
GITIGNORE_EOF
    print_success "Created .gitignore"
fi

# Commit any new files
if [ -n "$(git status --porcelain)" ]; then
    git add -A
    git commit -q -m "Update orchestrator workspace"
    print_success "Committed new files"
else
    print_warning "No new files to commit"
fi

# Add to Takopi if available
if command -v takopi-add-project &>/dev/null; then
    if takopi-add-project admin 2>/dev/null; then
        print_success "Added admin to Takopi config"
    else
        print_warning "Could not add to Takopi (may already exist)"
    fi
else
    print_warning "takopi-add-project not found - add manually later"
fi

echo ""
echo "Setup complete!"
echo ""
echo "Files:"
echo "  - CLAUDE.md: Instructions for the orchestrator agent"
echo "  - NOTES.md:  Cross-session memory (update this regularly)"
echo ""
echo "Next steps:"
echo "  1. In Telegram, go to your General topic (or create an 'admin' topic)"
echo "  2. Run: /ctx set admin"
echo "  3. Start using it for general VM tasks"
echo ""
echo "Optional: Add a remote later:"
echo "  git remote add origin git@github.com:your-org/vm-admin.git"
echo "  git push -u origin main"
